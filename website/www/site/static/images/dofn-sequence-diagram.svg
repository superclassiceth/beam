<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="740" height="863" contentScriptType="application/ecmascript" contentStyleType="text/css" style="width:740px;height:863px" preserveAspectRatio="none" version="1.1" viewBox="0 0 740 863" zoomAndPan="magnify"><g><rect style="stroke:#6b9fe6;stroke-width:1" width="10" height="781.563" x="49" y="60.813" fill="#6B9FE6"/><rect style="stroke:#6b9fe6;stroke-width:1" width="10" height="425.281" x="273" y="417.094" fill="#6B9FE6"/><rect style="stroke:#6b9fe6;stroke-width:1" width="10" height="425.281" x="547" y="417.094" fill="#6B9FE6"/><line style="stroke:#6b9fe6;stroke-width:1;stroke-dasharray:5,5" x1="54" x2="54" y1="50.813" y2="851.375"/><line style="stroke:#6b9fe6;stroke-width:1;stroke-dasharray:5,5" x1="278" x2="278" y1="50.813" y2="851.375"/><line style="stroke:#6b9fe6;stroke-width:1;stroke-dasharray:5,5" x1="551.5" x2="551.5" y1="50.813" y2="851.375"/><rect style="stroke:#8ac483;stroke-width:1.5" width="92" height="30.406" x="8" y="19.406" fill="#8AC483"/><text x="15" y="39.395" fill="#000" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78">User pipeline</text><rect style="stroke:#8ac483;stroke-width:1.5" width="94" height="46.813" x="231" y="3" fill="#8AC483"/><text x="238" y="24" fill="#000" font-family="Roboto" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="80">«Serializable»</text><text x="261.5" y="40.406" fill="#000" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="33">DoFn</text><rect style="stroke:#8ac483;stroke-width:1.5" width="59" height="30.406" x="522.5" y="19.406" fill="#8AC483"/><text x="529.5" y="39.395" fill="#000" font-family="Roboto" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45">Runner</text><rect style="stroke:#6b9fe6;stroke-width:1" width="10" height="781.563" x="49" y="60.813" fill="#6B9FE6"/><rect style="stroke:#6b9fe6;stroke-width:1" width="10" height="425.281" x="273" y="417.094" fill="#6B9FE6"/><rect style="stroke:#6b9fe6;stroke-width:1" width="10" height="425.281" x="547" y="417.094" fill="#6B9FE6"/><path fill="#CEE2F2" d="M283,65.8125 L283,105.8125 L515,105.8125 L515,75.8125 L505,65.8125 L283,65.8125" style="stroke:#cee2f2;stroke-width:1"/><path fill="#CEE2F2" d="M505,65.8125 L505,75.8125 L515,75.8125 L505,65.8125" style="stroke:#cee2f2;stroke-width:1"/><text x="289" y="82.873" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181">can have non-transient instance</text><text x="289" y="98.107" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211">variable state that will be deserialized</text><path fill="#CEE2F2" d="M283,116.2813 L283,156.2813 L643,156.2813 L643,126.2813 L633,116.2813 L283,116.2813" style="stroke:#cee2f2;stroke-width:1"/><path fill="#CEE2F2" d="M633,116.2813 L633,126.2813 L643,126.2813 L633,116.2813" style="stroke:#cee2f2;stroke-width:1"/><text x="289" y="133.342" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332">do not include enclosing class serializable state; use static</text><text x="289" y="148.576" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339">nested DoFn or define as anonymous class in static method</text><path fill="#CEE2F2" d="M283,166.75 L283,206.75 L725,206.75 L725,176.75 L715,166.75 L283,166.75" style="stroke:#cee2f2;stroke-width:1"/><path fill="#CEE2F2" d="M715,166.75 L715,176.75 L725,176.75 L715,166.75" style="stroke:#cee2f2;stroke-width:1"/><text x="289" y="183.81" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="421">no shared (global) static variable access (no sync mechanism) but a beam</text><text x="289" y="199.045" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="409">state (based on engine mechanisms) can be injected to processElement</text><path fill="#CEE2F2" d="M283,217.2188 L283,257.2188 L648,257.2188 L648,227.2188 L638,217.2188 L283,217.2188" style="stroke:#cee2f2;stroke-width:1"/><path fill="#CEE2F2" d="M638,217.2188 L638,227.2188 L648,227.2188 L638,217.2188" style="stroke:#cee2f2;stroke-width:1"/><text x="289" y="234.279" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344">keep as pure function as possible or idempotent side effects</text><text x="289" y="249.514" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269">because DoFns can be retried on failed bundles</text><polygon fill="#67666A" points="266 279.922 276 283.922 266 287.922 270 283.922" style="stroke:#67666a;stroke-width:1"/><line style="stroke:#67666a;stroke-width:2" x1="59" x2="272" y1="283.922" y2="283.922"/><text x="66" y="278.748" fill="#000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="69">create DoFn</text><polygon fill="#67666A" points="540 309.156 550 313.156 540 317.156 544 313.156" style="stroke:#67666a;stroke-width:1"/><line style="stroke:#67666a;stroke-width:2" x1="278" x2="546" y1="313.156" y2="313.156"/><text x="285" y="307.982" fill="#000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="250">passed instance or deserialized on workers</text><path fill="#CEE2F2" d="M64,326.1563 L64,366.1563 L405,366.1563 L405,336.1563 L395,326.1563 L64,326.1563" style="stroke:#cee2f2;stroke-width:1"/><path fill="#CEE2F2" d="M395,326.1563 L395,336.1563 L405,336.1563 L395,326.1563" style="stroke:#cee2f2;stroke-width:1"/><text x="70" y="343.217" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320">If state variables are known at pipeline construction step</text><text x="70" y="358.451" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216">initialize state variables by constructor</text><path fill="#8AC483" d="M201,378.625 L331,378.625 L331,385.625 L321,395.625 L201,395.625 L201,378.625" style="stroke:#8ac483;stroke-width:1"/><rect style="stroke:#8ac483;stroke-width:2" width="528" height="455.75" x="201" y="378.625" fill="none"/><text x="216" y="391.685" fill="#000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85">DoFn Lifecycle</text><polygon fill="#67666A" points="294 413.094 284 417.094 294 421.094 290 417.094" style="stroke:#67666a;stroke-width:1"/><line style="stroke:#67666a;stroke-width:2" x1="288" x2="546" y1="417.094" y2="417.094"/><text x="300" y="411.92" fill="#000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="55">call setup</text><path fill="#CEE2F2" d="M288,430.0938 L288,455.0938 L658,455.0938 L658,440.0938 L648,430.0938 L288,430.0938" style="stroke:#cee2f2;stroke-width:1"/><path fill="#CEE2F2" d="M648,430.0938 L648,440.0938 L658,440.0938 L648,430.0938" style="stroke:#cee2f2;stroke-width:1"/><text x="294" y="447.154" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="349">reused instance to process other bundles on the same worker</text><path fill="#CEE2F2" d="M288,465.3281 L288,505.3281 L719,505.3281 L719,475.3281 L709,465.3281 L288,465.3281" style="stroke:#cee2f2;stroke-width:1"/><path fill="#CEE2F2" d="M709,465.3281 L709,475.3281 L719,475.3281 L709,465.3281" style="stroke:#cee2f2;stroke-width:1"/><text x="294" y="482.389" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="410">If state variables do not depend on the main pipeline program and are the</text><text x="294" y="497.623" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288">same for all DoFn instances initialize them in setup</text><path fill="#8AC483" d="M211,517.7969 L347,517.7969 L347,524.7969 L337,534.7969 L211,534.7969 L211,517.7969" style="stroke:#8ac483;stroke-width:1"/><rect style="stroke:#8ac483;stroke-width:2" width="390.5" height="245.109" x="211" y="517.797" fill="none"/><text x="226" y="530.857" fill="#000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="91">For each bundle</text><polygon fill="#67666A" points="294 552.266 284 556.266 294 560.266 290 556.266" style="stroke:#67666a;stroke-width:1"/><line style="stroke:#67666a;stroke-width:2" x1="288" x2="546" y1="556.266" y2="556.266"/><text x="300" y="551.092" fill="#000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="89">call startBundle</text><path fill="#8AC483" d="M221,571.2656 L365,571.2656 L365,578.2656 L355,588.2656 L221,588.2656 L221,571.2656" style="stroke:#8ac483;stroke-width:1"/><rect style="stroke:#8ac483;stroke-width:2" width="370.5" height="126.172" x="221" y="571.266" fill="none"/><text x="236" y="584.326" fill="#000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99">For each element</text><polygon fill="#67666A" points="294 605.734 284 609.734 294 613.734 290 609.734" style="stroke:#67666a;stroke-width:1"/><line style="stroke:#67666a;stroke-width:2" x1="288" x2="546" y1="609.734" y2="609.734"/><text x="300" y="604.561" fill="#000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="116">call processElement</text><path fill="#CEE2F2" d="M288,622.7344 L288,662.7344 L569,662.7344 L569,632.7344 L559,622.7344 L288,622.7344" style="stroke:#cee2f2;stroke-width:1"/><path fill="#CEE2F2" d="M559,622.7344 L559,632.7344 L569,632.7344 L559,622.7344" style="stroke:#cee2f2;stroke-width:1"/><text x="294" y="639.795" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260">If state variables are computed by the pipeline</text><text x="294" y="655.029" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240">pass it in a PcollectionView as a side input</text><polygon fill="#67666A" points="535 685.438 545 689.438 535 693.438 539 689.438" style="stroke:#67666a;stroke-width:1"/><line style="stroke:#67666a;stroke-width:2;stroke-dasharray:2,2" x1="283" x2="541" y1="689.438" y2="689.438"/><text x="290" y="684.264" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36">output</text><polygon fill="#67666A" points="294 721.672 284 725.672 294 729.672 290 725.672" style="stroke:#67666a;stroke-width:1"/><line style="stroke:#67666a;stroke-width:2" x1="288" x2="546" y1="725.672" y2="725.672"/><text x="300" y="720.498" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70">call onTimer</text><polygon fill="#67666A" points="294 750.906 284 754.906 294 758.906 290 754.906" style="stroke:#67666a;stroke-width:1"/><line style="stroke:#67666a;stroke-width:2" x1="288" x2="546" y1="754.906" y2="754.906"/><text x="300" y="749.732" fill="#000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="94">call finishBundle</text><polygon fill="#67666A" points="535 787.141 545 791.141 535 795.141 539 791.141" style="stroke:#67666a;stroke-width:1"/><line style="stroke:#67666a;stroke-width:2" x1="283" x2="541" y1="791.141" y2="791.141"/><text x="290" y="785.967" fill="#000" font-family="Roboto" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="234">If DoFn is no more needed: call tearDown</text><path fill="#CEE2F2" d="M288,804.1406 L288,829.1406 L633,829.1406 L633,814.1406 L623,804.1406 L288,804.1406" style="stroke:#cee2f2;stroke-width:1"/><path fill="#CEE2F2" d="M623,804.1406 L623,814.1406 L633,814.1406 L623,804.1406" style="stroke:#cee2f2;stroke-width:1"/><text x="294" y="821.201" fill="#000" font-family="Roboto" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324">Call of teardown is best effort; do not use for side effects</text></g></svg>